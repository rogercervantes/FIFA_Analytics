---
title: "FIFA Analytics"
author: 'Autors:  
 * Rodrigo Rico  
 * Roger Cervantes'
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    #includes:
      #in_header: C:/UOC/UOC-header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
options(repr.plot.width = 20, repr.plot.height = 20)
rm(list = ls())
```


```{r library}

# Cargamos las librerías necesarias:
library(dplyr)
library(kableExtra)
library(GGally)

library(corrplot)

library(stringr)
library(gridExtra)
library(ggplot2)
library(DMwR)
library(caret)
library(ResourceSelection)
library(pROC)

library(magrittr)
library(maps)
library(plotly)
library(DT)
library(factoextra)
library(tidyr)
library(tibble)

```

```{r functions, message= FALSE, warning=FALSE}

# Creamos una serie de funciones para mejorar la visualización
my.head <- function(x, num=6){
  head(x, num) %>% 
    kable() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed", "hover")) %>%
    scroll_box(width="100%",height="264px") # 72 + 32*rows
}

my.kable <- function(x){
  x %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed", "hover")) %>%
    scroll_box(width="100%",height="264px") # 72 + 32*rows
}

my.summary <- function(x){
  summary(x) %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed", "hover")) %>%
    scroll_box(width="100%",height=72 + 32*7) 
}

# Creamos la lista de variables segun tipo
#fifa.var_cuanti <- unlist(lapply(fifa, is.numeric)) 
#fifa.var_cuali <- unlist(lapply(fifa, is.factor)) 

```


# Lectura del fichero

```{r LecFic}

# Leemos los ficheros
players_15 <- read.csv("Data/players_15.csv", sep=",", header=TRUE)
players_16 <- read.csv("Data/players_16.csv", sep=",", header=TRUE)
players_17 <- read.csv("Data/players_17.csv", sep=",", header=TRUE)
players_18 <- read.csv("Data/players_18.csv", sep=",", header=TRUE)
players_19 <- read.csv("Data/players_19.csv", sep=",", header=TRUE)
players_20 <- read.csv("Data/players_20.csv", sep=",", header=TRUE)

# Añadimos el año
players_15$year = as.integer(2015)
players_16$year = as.integer(2016)
players_17$year = as.integer(2017)
players_18$year = as.integer(2018)
players_19$year = as.integer(2019)
players_20$year = as.integer(2020)

# Los juntamos todos
fifa <- rbind(players_15, players_16, players_17, players_18, players_19, players_20)

# Limpiamos memoria
rm(players_15, players_16, players_17, players_18, players_19, players_20)

# Hacemos una primera visualización
my.head(fifa)

# Analizamos la estructura de las variables
str(fifa)


```


## Selección de registros

```{r LecFic_Rows}

# Vamos a analizar solo algunas ligas

bundesliga <- c(
  "1. FC Nürnberg", "1. FSV Mainz 05", "Bayer 04 Leverkusen", "FC Bayern München",
  "Borussia Dortmund", "Borussia Mönchengladbach", "Eintracht Frankfurt",
  "FC Augsburg", "FC Schalke 04", "Fortuna Düsseldorf", "Hannover 96",
  "Hertha BSC", "RB Leipzig", "SC Freiburg", "TSG 1899 Hoffenheim",
  "VfB Stuttgart", "VfL Wolfsburg", "SV Werder Bremen"
)

laLiga <- c(
  "Athletic Club de Bilbao", "Atlético Madrid", "CD Leganés",
  "Deportivo Alavés", "FC Barcelona", "Getafe CF", "Girona FC", 
  "Levante UD", "Rayo Vallecano", "RC Celta", "RCD Espanyol", 
  "Real Betis", "Real Madrid", "Real Sociedad", "Real Valladolid CF",
  "SD Eibar", "SD Huesca", "Sevilla FC", "Valencia CF", "Villarreal CF"
)

serieA <- c(
  "Atalanta","Bologna","Cagliari","Chievo Verona","Empoli", "Fiorentina","Frosinone","Genoa",
  "Inter","Juventus","Lazio","Milan","Napoli","Parma","Roma","Sampdoria","Sassuolo","SPAL",
  "Torino","Udinese"
  
)

premierLeague <- c(
  "Arsenal", "Bournemouth", "Brighton & Hove Albion", "Burnley",
  "Cardiff City", "Chelsea", "Crystal Palace", "Everton", "Fulham",
  "Huddersfield Town", "Leicester City", "Liverpool", "Manchester City",
  "Manchester United", "Newcastle United", "Southampton", 
  "Tottenham Hotspur", "Watford", "West Ham United", "Wolverhampton Wanderers"
  
)

fifa %<>% mutate(
    League = case_when(
        club %in% bundesliga ~ "Bundesliga",
        club %in% laLiga ~ "La Liga",
        club %in% serieA ~ "Serie A",
        club %in% premierLeague ~ "Premier League"
    ),
    Country = case_when(
        League == "Bundesliga" ~ "Germany",
        League == "La Liga" ~ "Spain",
        League == "Serie A" ~ "Italy",
        League == "Premier League" ~ "UK"
    )
) 


# Nos quedamos solo con los registros de esas ligas
fifa %<>% filter(!is.na(League))

# Factorizamos las variables
fifa$League <- factor(fifa$League)
fifa$Country <- factor(fifa$Country)

table(fifa$League)
table(fifa$Country)

# Limpiamos memoria
rm(bundesliga, laLiga, serieA, premierLeague)
```


## Eliminamos variables

```{r LecFic_cols}

# Como el dataframe es muy grande, nos quedamos solo con las variables relevantes
#selected <- c("short_name", "age", "club", "nationality", "overall", "potential",
#              "height_cm","weight_kg","value_eur", "wage_eur", "preferred_foot",
#              "team_position", "nation_position", 
#              "pace", "shooting", "passing", "dribbling", "defending", "physic", 
#              "gk_diving", "gk_handling", "gk_kicking", "gk_reflexes", "gk_speed", "gk_positioning",
#              "attacking_crossing", "attacking_finishing", "attacking_heading_accuracy", "attacking_short_passing", "attacking_volleys",
#              "skill_dribbling", "skill_curve", "skill_fk_accuracy","skill_long_passing", "skill_ball_control", 
#              "movement_acceleration", "movement_sprint_speed", "movement_agility", "movement_reactions", "movement_balance", 
#              "power_shot_power", "power_jumping", "power_stamina", "power_strength", "power_long_shots",
#              "mentality_aggression","mentality_interceptions","mentality_positioning","mentality_vision","mentality_penalties","mentality_composure",
#              "defending_marking", "defending_standing_tackle", "defending_sliding_tackle", 
#              "goalkeeping_diving", "goalkeeping_handling", "goalkeeping_kicking","goalkeeping_positioning", "goalkeeping_reflexes",
#              "ls","st","rs","lw","lf","cf","rf","rw","lam","cam","ram","lm","lcm",
#              "cm","rcm","rm","lwb","ldm","cdm","rdm","rwb","lb","lcb","cb","rcb","rb"
#              "year")
#fifa <- select(fifa, selected)

# Limpiamos memoria
#rm(selected)

```


## Añadimos Variables

### Position Name

```{r create.position_names}

# Analizamos team_position
str(fifa$team_position)
table(fifa$team_position)

# TODO: Faltan 5 definiciones y los blancos
Pos <- data.frame("team_position" = c("GK", "LB", "CB","RB", "RM", "CM", "LM", "LW", "ST", "RW",
                                      "CAM","CDM","CF","LAM","LCB","LCM","LDM","LF","LS","RAM","RCB","RCM","RDM",
                                      "LWB","RES","RF","RS","RWB","SUB"),
                 "position_names" = c("GoalKeeper","Left Back","Center Back","Right Back",
                                      "Attack Mid","Midfield","Attack Mid","Left Wing","Forward",
                                      "Right Wing","Attack Mid","Defense Mid","Forward","Midfield",
                                      "Center Back","Attack Mid","Defense Mid","Attack Mid","Left Wing",
                                      "Attack Mid","Center Back","Attack Mid","Defense Mid",
                                      "DESCONOCIDO","DESCONOCIDO","DESCONOCIDO","DESCONOCIDO","DESCONOCIDO","DESCONOCIDO")
                )

fifa <- merge(x=fifa,y=Pos,by="team_position",all.x = TRUE)

rm(Pos)
my.head(fifa)

```


### Position Class

```{r create.Position.Class}

str(fifa$team_position)
table(fifa$team_position)

str(fifa$nation_position)
table(fifa$nation_position)


defence <- c("CB", "RB", "LB", "LWB", "RWB", "LCB", "RCB")
midfielder <- c("CM", "CDM","CAM","LM","RM", "LAM", "RAM", "LCM", "RCM", "LDM", "RDM")
forward = c("ST", "LW", "RW", "LF", "RF", "RS","LS", "CF")

fifa %<>% 
  mutate(team_position.Class   = if_else(team_position %in% "GK", "Goal Keeper",
                                 if_else(team_position %in% defence, "Defender",
                                 if_else(team_position %in% midfielder, "Midfielder",
                                 if_else(team_position %in% forward, "Forward", "NA")))),
         nation_position.Class = if_else(nation_position %in% "GK", "Goal Keeper",
                                 if_else(nation_position %in% defence, "Defender",
                                 if_else(nation_position %in% midfielder, "Midfielder",
                                 if_else(nation_position %in% forward, "Forward", "NA"))))
         )

rm(defence, midfielder,forward)

table(fifa$team_position.Class)
table(fifa$nation_position.Class)


```

```{r create.Position.Class_2}

# TODO: Que es SUB?
#fifa %>%
#  filter(team_position == "SUB")  %>%
#  my.head()

# TODO: Que es RES?
#fifa %>%
#  filter(team_position == "RES")  %>%
#  my.kable()

# Validamos registros con posiciones diferentes
fifa %>% 
  select(short_name, team_position.Class,nation_position.Class) %>% 
  filter(team_position.Class != nation_position.Class) %>% 
  filter(team_position.Class != "NA") %>% 
  filter(nation_position.Class != "NA") %>% 
  my.head()

```


## Estructura Final

```{r est_Final}

# Hacemos una primera visualización
my.head(fifa)

# Analizamos la estructura de las variables
str(fifa)

```


# Analisis

## Valores Perdidos

```{r valoresPerdidos}

# Miramos que variables tienen valores perdidos
sort(colSums(is.na(fifa)), decreasing = TRUE)
sort(colSums(fifa==""), decreasing = TRUE)
sort(colSums(fifa==0), decreasing = TRUE)

# Nos guardamos los índices de los valores perdidos
#ValPer.ind <- which(fifa$value_eur==0)

# Mostramos los registros con valores perdidos
#my.kable(fifa[ValPer.ind,])

# Rellenamos los NULLs con el método knn (vecino)
#df=as.data.frame(knnImputation(df,k = 5, scale = T))

# Mostramos los registros con NA
#my.kable(df[df_n_hos_beds_NA_Idx,])

```



**comentario:**
No tenemos valores NA.  
Blancos solo hay en la variable de *'nation_position'* que quiere decir que no han jugado con la selección.
Registros con valor 0 solo hay en el valor del jugador (*'value_eur'*)

TODO: Mirar que hacemos con estos valores.

## Valores Extremos

```{r boxplot}

gp1 <- ggplot(fifa, aes(x=team_position.Class, y=age, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp2 <- ggplot(fifa, aes(x=team_position.Class, y=overall, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp3 <- ggplot(fifa, aes(x=team_position.Class, y=potential, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp4 <- ggplot(fifa, aes(x=team_position.Class, y=height_cm, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp5 <- ggplot(fifa, aes(x=team_position.Class, y=weight_kg, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp6 <- ggplot(fifa, aes(x=team_position.Class, y=value_eur, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp7 <- ggplot(fifa, aes(x=team_position.Class, y=wage_eur, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 

grid.arrange(gp1, gp2, gp3, gp4, ncol = 2)
grid.arrange(gp5, gp6, gp7, ncol = 2)

# Limpiamos memoria
rm(gp1, gp2, gp3, gp4, gp5, gp6, gp7)

#table(boxplot.stats(fifa$value_eur)$out)

```


## Correlacion

```{r corr}

fifa.var_cuanti <- unlist(lapply(fifa, is.numeric)) 
ggcorr(fifa[fifa.var_cuanti], label = FALSE, label_size = 2.9, hjust = 1, layout.exp = 2)


```

## Más limpieza

```{r}
# Eliminamos los datos que tengan vacíos alguno de los dos campos objetivo
fifa <- fifa %>% filter(value_eur != 0)
fifa <- fifa %>% filter(!is.na(value_eur))
fifa <- fifa %>% filter(team_position.Class != "NA")
table(fifa$team_position.Class)
```

Las varibles que albergan las métricas que definen el rendimiento del jugador en el juego están acompañadas por un valor fijo y una cantidad variable que se suma a éste, para representar la evolución del jugador durante algunos modos de juego. Para este análisis nos quedaremos con la parte fija.

```{r}
# Pasamos las métricas de rendimiento nuevas a numéricas

for(i in 45:104) {       # Iteramos sobre las métricas que queremos limpiar
  fifa[,i] <- as.numeric(substr(fifa[,i], 1, 2)) # Cogemos los dos primeros caracteres y a numeric
  # VALORES VACÍOS DE STAS VARIABLES POR LA MEDIANA DEL GRUPO (PORTEROS, DEFENSAS, MEDIOCENTROS, DELANTEROS)
}
```

PARA ROGER: He dejado una línea dentro del bucle para que sustituyas los valores vacíos de cada una de las 60 variables de habilidades extra por la mediana del valor de esa habilidad de los integrantes de su grupo. Por ejemplo, si Ter Stegen tiene el campo `rb` vacío, debe sustituirse por la mediana de los valores `rb` de los porteros. He intentado hacerlo yo pero no lo consigo. Además, para aplicar *PCA* sobre estas 60 variables es necesario haber imputado antes sus valores vacíos.

# Análisis exploratorio de los datos (EDA)
Definimos esta función que se usará para representar varias gráficas en la misma celda con la librería `ggplot2`.

```{r}
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

## Datos de partida
Los datos de partida en el EDA se encuentran en el *dataset* `fifa` resultado del proceso previo de limpieza realizado por Roger.

```{r}
# Visualizamos los datos de partida para el EDA
my.head(fifa)
```


Una vez planteados los objetivos analíticos, el primer paso del análisis exploratorio es estudiar la distribución de las variables predictoras y su dependencia con las variables a predecir. También resulta interesante observar la correlación entre variables predictoras.

## Variables objetivo
Las variables objetivo de este análisis son:

* El valor de mercado de los jugadores en euros: `value_eur`.
* La posición de los jugadores en el terreno de juego: `team_position.Class`.

Representamos a continuación las distribuciones de ambas magnitudes:

```{r}
h1 <- ggplot(fifa, aes(x = value_eur, fill = "red")) + geom_density(alpha = 0.6) + theme(legend.position = "none")
h2 <- ggplot(fifa, aes(x = team_position.Class, fill = team_position.Class)) + geom_bar() + theme(legend.position = "none")

multiplot(h1, h2, cols=1)
```

La distribución del valor de mercado sigue una ley de distribución *Gamma* a simple vista.

```{r}
library(fitdistrplus)
# En lugar de ajustar los valores en euros lo haremos en millones de euros:
x.gamma <- fifa$value_eur/10e6
fit.gamma <- fitdist(x.gamma, distr = "gamma")
summary(fit.gamma)

plot(fit.gamma)
```

(Los resultados de los ajustes los comentaremos en el documento PDF)

Influencia de la posición del jugador en el valor de mercado:

```{r}
ggplot(fifa, aes(x = value_eur, colour = team_position.Class)) + geom_density()
```

Parece existir una ligera influencia de la posición del jugador en valor de mercado. Si observamos la posición de los picos y la altura de la falda derecha de las distribuciones, nos daremos cuenta de que los delanteros tienden a ser más caros que los defensas.

## Edad, peso y altura
```{r}
h1 <- ggplot(fifa, aes(x = age, fill = "red")) + geom_density(alpha = 0.6) + theme(legend.position = "none")
h2 <- ggplot(fifa, aes(x = height_cm, fill = "red")) + geom_density(alpha = 0.6) + theme(legend.position = "none")
h3 <- ggplot(fifa, aes(x = weight_kg, fill = "red")) + geom_density(alpha = 0.6) + theme(legend.position = "none")

multiplot(h1, h2, h3, cols=1)
```

Podemos observar si existe dependencia entre estas variables y la posición del jugador:

```{r}
h1 <- ggplot(fifa, aes(x = age, colour = team_position.Class)) + geom_density() 
h2 <- ggplot(fifa, aes(x = height_cm, colour = team_position.Class)) + geom_density() 
h3 <- ggplot(fifa, aes(x = weight_kg, colour = team_position.Class)) + geom_density() 

multiplot(h1, h2, h3, cols=1)
```

* Edad: no se aprecian diferencias muy acuciantes entre las edades de cada grupo. Aunque existe una ligera tendencia entre los porteros a tener mayor edad. 
* Altura: en caso sí se observa que los porteros son signifcativamente más altos, y que los jugadores más bajos son los mediocentros.
* Peso: los porteros son significativamente más pesados.

En general, se observan diferencias entre las distribuciones de porteros, defensas, mediocentros y delanteros. Por tanto estas variables pueden resultar útiles para el análisis de la posición óptima de los jugadores.

Ahora vamos a ver la dependencia con la otra variable objetivo: el valor de mercado `value_eur`:

```{r}
h1 <- ggplot(fifa, aes(x=age, y=value_eur)) + geom_point()
h2 <- ggplot(fifa, aes(x=height_cm, y=value_eur)) + geom_point()
h3 <- ggplot(fifa, aes(x=weight_kg, y=value_eur)) + geom_point()

multiplot(h1, h2, h3, cols=1)
```

Como vemos, tanto el peso como la altura no parecen tener demasiada influencia en el valor del jugador. La edad tampoco tiene una influencia muy marcada, sin embargo si puede observarse una caída paulatina del precio cuando se superan los 32 años, también se puede ver que los jugadores jóvenes no llegan a su precio máximo hasta los 23. En la horquilla entre los 23 y los 32 años de edad el valor parece no tener una influencia grande.

Para terminar con esta terna de variables, podemos representar la correlación entre ellas y la correlación con el valor de mercado (al ser ésta una variable numérica):

```{r}
ggcorr(fifa[c(14,6,8,9)], label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
```

Como era de esperar por los resultados gráficos obtenidos, la edad, el peso y la altura no son buenos predictores del valor de mercado, por lo tanto no se incluirán en el análisis de la predicción de éste. Algo que se esperaba es la estrecha correlación entre la altura y el peso. La altura y el peso son dos variables que pueden influir en la posición del jugador, como se ha observado en los gráficos, pero al estar tan estrechamente correlacionadas la mejor opción puede ser tomar una sola para el análisis de la posición.

## Habilidades básicas

Las habilidades son las variables que más influencia se espera que tengan en la predicción tanto de la posición del jugador como de su valor de mercado.

En el juego un jugador está representado por 6 habilidades básicas. Que son `pace`,`shooting`, `passing`, `dribbling`, `defending` y `physical`. 

![player overview](player_overview.jpg)

Para hacer un análisis exploratorio más significativo y adaptado a nuestro objetivo, representaremos cada una de estas habilidades sobre cada una de las tres clases de posiciones: defensores (`Defender`), mediocampistas (`Midfielder`) y atacantes (`Forward`):

```{r message= FALSE, warning=FALSE}
library(ggplot2)

d1 <- ggplot(fifa, aes(x = pace, colour = team_position.Class)) + geom_density()
d2 <- ggplot(fifa, aes(x = shooting, colour = team_position.Class)) + geom_density()
d3 <- ggplot(fifa, aes(x = passing, colour = team_position.Class)) + geom_density()

multiplot(d1, d2, d3, cols=1)
```
```{r}
d4 <- ggplot(fifa, aes(x = dribbling, colour = team_position.Class)) + geom_density()
d5 <- ggplot(fifa, aes(x = defending, colour = team_position.Class)) + geom_density()
d6 <- ggplot(fifa, aes(x = physic, colour = team_position.Class)) + geom_density()

multiplot(d4, d5, d6, cols=1)
```

Se puede observar la diferencia en las distribuciones entre cada una de las tres posiciones. A continuación se calcula la media de cada una de las distribuciones anteriores:

```{r}
pace <- c(mean(fifa$pace[fifa$team_position.Class == "Defender"]),
           mean(fifa$pace[fifa$team_position.Class == "Midfielder"]),
           mean(fifa$pace[fifa$team_position.Class == "Forward"]))

shooting <- c(mean(fifa$shooting[fifa$team_position.Class == "Defender"]),
           mean(fifa$shooting[fifa$team_position.Class == "Midfielder"]),
           mean(fifa$shooting[fifa$team_position.Class == "Forward"]))

passing <- c(mean(fifa$passing[fifa$team_position.Class == "Defender"]),
           mean(fifa$passing[fifa$team_position.Class == "Midfielder"]),
           mean(fifa$passing[fifa$team_position.Class == "Forward"]))

dribbling <- c(mean(fifa$dribbling[fifa$team_position.Class == "Defender"]),
           mean(fifa$dribbling[fifa$team_position.Class == "Midfielder"]),
           mean(fifa$dribbling[fifa$team_position.Class == "Forward"]))

defending <- c(mean(fifa$defending[fifa$team_position.Class == "Defender"]),
           mean(fifa$defending[fifa$team_position.Class == "Midfielder"]),
           mean(fifa$defending[fifa$team_position.Class == "Forward"]))

physic <- c(mean(fifa$physic[fifa$team_position.Class == "Defender"]),
           mean(fifa$physic[fifa$team_position.Class == "Midfielder"]),
           mean(fifa$physic[fifa$team_position.Class == "Forward"]))

positions <- c("Defender", "Midfielder", "Forward")

means <- data.frame(positions, pace, shooting, passing, dribbling, defending, physic)
my.head(means)
```

Y las desviaciones estándar:

```{r}
pace <- c(sd(fifa$pace[fifa$team_position.Class == "Defender"]),
           sd(fifa$pace[fifa$team_position.Class == "Midfielder"]),
           sd(fifa$pace[fifa$team_position.Class == "Forward"]))

shooting <- c(sd(fifa$shooting[fifa$team_position.Class == "Defender"]),
           sd(fifa$shooting[fifa$team_position.Class == "Midfielder"]),
           sd(fifa$shooting[fifa$team_position.Class == "Forward"]))

passing <- c(sd(fifa$passing[fifa$team_position.Class == "Defender"]),
           sd(fifa$passing[fifa$team_position.Class == "Midfielder"]),
           sd(fifa$passing[fifa$team_position.Class == "Forward"]))

dribbling <- c(sd(fifa$dribbling[fifa$team_position.Class == "Defender"]),
           sd(fifa$dribbling[fifa$team_position.Class == "Midfielder"]),
           sd(fifa$dribbling[fifa$team_position.Class == "Forward"]))

defending <- c(sd(fifa$defending[fifa$team_position.Class == "Defender"]),
           sd(fifa$defending[fifa$team_position.Class == "Midfielder"]),
           sd(fifa$defending[fifa$team_position.Class == "Forward"]))

physic <- c(sd(fifa$physic[fifa$team_position.Class == "Defender"]),
           sd(fifa$physic[fifa$team_position.Class == "Midfielder"]),
           sd(fifa$physic[fifa$team_position.Class == "Forward"]))

positions <- c("Defender", "Midfielder", "Forward")

sdevs <- data.frame(positions, pace, shooting, passing, dribbling, defending, physic)
my.head(sdevs)
```

En la tabla de medias podemos apreciar en forma numérica las diferencias que se visualizaban en las gráficas anteriores. Podemos concluir que las seis habilidades básicas son buenas predictoras de la posición del jugador y por tanto deben estar presentes en el modelo de clasificación.

En cuanto a la dependencia de éstas con el valor de mercado del jugador:

```{r}
h1 <- ggplot(fifa, aes(x=pace, y=value_eur)) + geom_point()
h2 <- ggplot(fifa, aes(x=shooting, y=value_eur)) + geom_point()
h3 <- ggplot(fifa, aes(x=passing, y=value_eur)) + geom_point()

multiplot(h1, h2, h3, cols=1)
```

```{r}
h1 <- ggplot(fifa, aes(x=dribbling, y=value_eur)) + geom_point()
h2 <- ggplot(fifa, aes(x=defending, y=value_eur)) + geom_point()
h3 <- ggplot(fifa, aes(x=physic, y=value_eur)) + geom_point()

multiplot(h1, h2, h3, cols=1)
```

Observamos cierta relación entre cada una de las habilidades y el valor del jugador. Especialmente en las habilidades de atacante, que suelen ser los jugadores más cotizados. Sin embargo la correlación no es todo lo clara que podría esperarse, hay variables donde ni siquiera se observa relación alguna. Esto ocurre porque una habilidad por sí sola no hace a un jugador más caro o barato, si no el conjunto de ellas.

Para observar este fenómenos representaremos el `overall rating` y el `potential` en función del valor de mercado:

```{r}
h1 <- ggplot(fifa, aes(x=overall, y=value_eur)) + geom_point()
h2 <- ggplot(fifa, aes(x=potential, y=value_eur)) + geom_point()

multiplot(h1, h2, cols = 1)
```

Para cuantificar todas estas dependencias, calculamos los coeficientes de correlación entre cada una de las habilidades y el valor de mercado, incluyendo el `overall`:

```{r}
ggcorr(fifa[c(14,11,12,32,33,34,35,36,37)], label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
```

Vemos la fuerte dependencia entre el `overall` y el valor de mercado. Dados estos resultados, para el estudio del valor de mercado se usaría el `overall` y las variables `pace`, `shooting`, `passing` y `dribbling`. Se excluirían del análisis `defending` y `physic` por presentar una correlación con la variable objetivo menor a 0.2. Por otra parte, hay que tener en cuenta que estamos analizando en el mismo conjunto a los delanteros y a los defensas y mediocentros. ¿Cambiarían estos coeficientes si los representamos por separado para cada posición?

```{r}
fifa.def <- fifa %>% filter(team_position.Class == "Defender")
fifa.mid <- fifa %>% filter(team_position.Class == "Midfielder")
fifa.for <- fifa %>% filter(team_position.Class == "Forward")

h1 <- ggcorr(fifa.def[c(14,11,12,32,33,34,35,36,37)], label = TRUE, label_size = 3, hjust = 1, layout.exp = 2)
h2 <- ggcorr(fifa.mid[c(14,11,12,32,33,34,35,36,37)], label = TRUE, label_size = 3, hjust = 1, layout.exp = 2)
h3 <- ggcorr(fifa.for[c(14,11,12,32,33,34,35,36,37)], label = TRUE, label_size = 3, hjust = 1, layout.exp = 2)

multiplot(h1, h2, h3, cols = 2)
```

Vemos como las habilidades que son importantes para el valor en los defensas (`defending` y `physic`), no lo son para los delanteros, y viceversa. Entonces, ¿qué variables seleccionamos para el análisis? 

Recordamos que tenemos dos objetivos analíticos:

* Predecir el valor de mercado mediante regresión.
* Clasificar cada jugador en su posición óptima.

El valor de mercado depende de la posición (y de otras variables) pero la posición no depende del valor de mercado. Entonces a la hora de construir nuestro *pipeline*, lo correcto es colocar el clasificador en primera línea y aplicar la regresión por separado a defensas, mediocentros y delanteros, así podremos seleccionar las mejores variables predictoras en cada caso.

En resumen, en lugar de realizar la regresión sobre el conjunto total de jugadores y dejar en manos de un algoritmo la selección de las variables predictoras más importantes, aprovechamos que conocemos de antemano las variables más determinantes para cada posición y aplicamos la regresión por separado personalizando más el análisis a cada tipo de jugador.

![fifa pipeline](fifa_pipeline.png)

## Habilidades extra
Si observamos el *dataset* podemos ver que estas seis no son las únicas variables que el juego utiliza para caracterizar a cada jugador. Existe una larga lista de variables adicionales, unas 60. Sin embargo, para evitar saturar el problema de regresión, intentaremos reducir esas 60 variables a 5 mediante métodos de reducción de la dimensionalidad como *PCA*.












