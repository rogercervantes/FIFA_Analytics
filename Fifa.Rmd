---
title: "FIFA Analytics"
author: 'Autors:  
 * Rodrigo Rico  
 * Roger Cervantes'
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: C:/UOC/UOC-header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
options(repr.plot.width = 16, repr.plot.height = 12)
rm(list = ls())
```


```{r library}

# Cargamos las librerías necesarias:
library(dplyr)
library(kableExtra)
library(GGally)

library(corrplot)

library(stringr)
library(gridExtra)
library(ggplot2)
library(DMwR)
library(caret)
library(ResourceSelection)
library(pROC)

library(magrittr)
library(maps)
library(plotly)
library(DT)
library(factoextra)
library(tidyr)
library(tibble)

```

```{r functions, message= FALSE, warning=FALSE}

# Creamos una serie de funciones para mejorar la visualización
my.head <- function(x, num=6){
  head(x, num) %>% 
    kable() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed", "hover")) %>%
    scroll_box(width="100%",height="264px") # 72 + 32*rows
}

my.kable <- function(x){
  x %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed", "hover")) %>%
    scroll_box(width="100%",height="264px") # 72 + 32*rows
}

my.summary <- function(x){
  summary(x) %>%
    kable() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed", "hover")) %>%
    scroll_box(width="100%",height=72 + 32*7) 
}

# Creamos la lista de variables segun tipo
#fifa.var_cuanti <- unlist(lapply(fifa, is.numeric)) 
#fifa.var_cuali <- unlist(lapply(fifa, is.factor)) 

```


# Lectura del fichero

```{r LecFic}

# Leemos los ficheros
players_15 <- read.csv("Data/players_15.csv", sep=",", header=TRUE)
players_16 <- read.csv("Data/players_16.csv", sep=",", header=TRUE)
players_17 <- read.csv("Data/players_17.csv", sep=",", header=TRUE)
players_18 <- read.csv("Data/players_18.csv", sep=",", header=TRUE)
players_19 <- read.csv("Data/players_19.csv", sep=",", header=TRUE)
players_20 <- read.csv("Data/players_20.csv", sep=",", header=TRUE)

# Añadimos el año
players_15$year = as.integer(2015)
players_16$year = as.integer(2016)
players_17$year = as.integer(2017)
players_18$year = as.integer(2018)
players_19$year = as.integer(2019)
players_20$year = as.integer(2020)

# Los juntamos todos
fifa <- rbind(players_15, players_16, players_17, players_18, players_19, players_20)

# Limpiamos memoria
rm(players_15, players_16, players_17, players_18, players_19, players_20)

# Hacemos una primera visualización
my.head(fifa)

# Analizamos la estructura de las variables
str(fifa)


```


## Selección de registros

```{r LecFic_Rows}

# Vamos a analizar solo algunas ligas

bundesliga <- c(
  "1. FC Nürnberg", "1. FSV Mainz 05", "Bayer 04 Leverkusen", "FC Bayern München",
  "Borussia Dortmund", "Borussia Mönchengladbach", "Eintracht Frankfurt",
  "FC Augsburg", "FC Schalke 04", "Fortuna Düsseldorf", "Hannover 96",
  "Hertha BSC", "RB Leipzig", "SC Freiburg", "TSG 1899 Hoffenheim",
  "VfB Stuttgart", "VfL Wolfsburg", "SV Werder Bremen"
)

laLiga <- c(
  "Athletic Club de Bilbao", "Atlético Madrid", "CD Leganés",
  "Deportivo Alavés", "FC Barcelona", "Getafe CF", "Girona FC", 
  "Levante UD", "Rayo Vallecano", "RC Celta", "RCD Espanyol", 
  "Real Betis", "Real Madrid", "Real Sociedad", "Real Valladolid CF",
  "SD Eibar", "SD Huesca", "Sevilla FC", "Valencia CF", "Villarreal CF"
)

serieA <- c(
  "Atalanta","Bologna","Cagliari","Chievo Verona","Empoli", "Fiorentina","Frosinone","Genoa",
  "Inter","Juventus","Lazio","Milan","Napoli","Parma","Roma","Sampdoria","Sassuolo","SPAL",
  "Torino","Udinese"
  
)

premierLeague <- c(
  "Arsenal", "Bournemouth", "Brighton & Hove Albion", "Burnley",
  "Cardiff City", "Chelsea", "Crystal Palace", "Everton", "Fulham",
  "Huddersfield Town", "Leicester City", "Liverpool", "Manchester City",
  "Manchester United", "Newcastle United", "Southampton", 
  "Tottenham Hotspur", "Watford", "West Ham United", "Wolverhampton Wanderers"
  
)

fifa %<>% mutate(
    League = case_when(
        club %in% bundesliga ~ "Bundesliga",
        club %in% laLiga ~ "La Liga",
        club %in% serieA ~ "Serie A",
        club %in% premierLeague ~ "Premier League"
    ),
    Country = case_when(
        League == "Bundesliga" ~ "Germany",
        League == "La Liga" ~ "Spain",
        League == "Serie A" ~ "Italy",
        League == "Premier League" ~ "UK"
    )
) 


# Nos quedamos solo con los registros de esas ligas
fifa %<>% filter(!is.na(League))

# Factorizamos las variables
fifa$League <- factor(fifa$League)
fifa$Country <- factor(fifa$Country)

table(fifa$League)
table(fifa$Country)

# Limpiamos memoria
rm(bundesliga, laLiga, serieA, premierLeague)
```


## Eliminamos variables

```{r LecFic_cols}

# Como el dataframe es muy grande, nos quedamos solo con las variables relevantes
selected <- c("short_name", "age", "club", "nationality", "overall", "potential",
              "height_cm","weight_kg","value_eur", "wage_eur", "preferred_foot",
              "team_position", "nation_position", 
#              "pace", "shooting", "passing", "dribbling", "defending", "physic", 
#              "gk_diving", "gk_handling", "gk_kicking", "gk_reflexes", "gk_speed", "gk_positioning",
#              "attacking_crossing", "attacking_finishing", "attacking_heading_accuracy", "attacking_short_passing", "attacking_volleys",
#              "skill_dribbling", "skill_curve", "skill_fk_accuracy","skill_long_passing", "skill_ball_control", 
#              "movement_acceleration", "movement_sprint_speed", "movement_agility", "movement_reactions", "movement_balance", 
#              "power_shot_power", "power_jumping", "power_stamina", "power_strength", "power_long_shots",
#              "mentality_aggression","mentality_interceptions","mentality_positioning","mentality_vision","mentality_penalties","mentality_composure",
#              "defending_marking", "defending_standing_tackle", "defending_sliding_tackle", 
#              "goalkeeping_diving", "goalkeeping_handling", "goalkeeping_kicking","goalkeeping_positioning", "goalkeeping_reflexes",
#              "ls","st","rs","lw","lf","cf","rf","rw","lam","cam","ram","lm","lcm",
#              "cm","rcm","rm","lwb","ldm","cdm","rdm","rwb","lb","lcb","cb","rcb","rb"
              "year")
fifa <- select(fifa, selected)

# Limpiamos memoria
rm(selected)

```


## Añadimos Variables

### Position Name

```{r create.position_names}

# Analizamos team_position
str(fifa$team_position)
table(fifa$team_position)

# TODO: Faltan 5 definiciones y los blancos
Pos <- data.frame("team_position" = c("GK", "LB", "CB","RB", "RM", "CM", "LM", "LW", "ST", "RW",
                                      "CAM","CDM","CF","LAM","LCB","LCM","LDM","LF","LS","RAM","RCB","RCM","RDM",
                                      "LWB","RES","RF","RS","RWB","SUB"),
                 "position_names" = c("GoalKeeper","Left Back","Center Back","Right Back",
                                      "Attack Mid","Midfield","Attack Mid","Left Wing","Forward",
                                      "Right Wing","Attack Mid","Defense Mid","Forward","Midfield",
                                      "Center Back","Attack Mid","Defense Mid","Attack Mid","Left Wing",
                                      "Attack Mid","Center Back","Attack Mid","Defense Mid",
                                      "DESCONOCIDO","DESCONOCIDO","DESCONOCIDO","DESCONOCIDO","DESCONOCIDO","DESCONOCIDO")
                )

fifa <- merge(x=fifa,y=Pos,by="team_position",all.x = TRUE)

rm(Pos)
my.head(fifa)

```


### Position Class

```{r create.Position.Class}

str(fifa$team_position)
table(fifa$team_position)

str(fifa$nation_position)
table(fifa$nation_position)


defence <- c("CB", "RB", "LB", "LWB", "RWB", "LCB", "RCB")
midfielder <- c("CM", "CDM","CAM","LM","RM", "LAM", "RAM", "LCM", "RCM", "LDM", "RDM")
forward = c("ST", "LW", "RW", "LF", "RF", "RS","LS", "CF")

fifa %<>% 
  mutate(team_position.Class   = if_else(team_position %in% "GK", "Goal Keeper",
                                 if_else(team_position %in% defence, "Defender",
                                 if_else(team_position %in% midfielder, "Midfielder",
                                 if_else(team_position %in% forward, "Forward", "NA")))),
         nation_position.Class = if_else(nation_position %in% "GK", "Goal Keeper",
                                 if_else(nation_position %in% defence, "Defender",
                                 if_else(nation_position %in% midfielder, "Midfielder",
                                 if_else(nation_position %in% forward, "Forward", "NA"))))
         )

rm(defence, midfielder,forward)

table(fifa$team_position.Class)
table(fifa$nation_position.Class)


```

```{r create.Position.Class_2}

# TODO: Que es SUB?
#fifa %>%
#  filter(team_position == "SUB")  %>%
#  my.head()

# TODO: Que es RES?
#fifa %>%
#  filter(team_position == "RES")  %>%
#  my.kable()

# Validamos registros con posiciones diferentes
fifa %>% 
  select(short_name, team_position.Class,nation_position.Class) %>% 
  filter(team_position.Class != nation_position.Class) %>% 
  filter(team_position.Class != "NA") %>% 
  filter(nation_position.Class != "NA") %>% 
  my.head()

```


## Estructura Final

```{r est_Final}

# Hacemos una primera visualización
my.head(fifa)

# Analizamos la estructura de las variables
str(fifa)

```


# Analisis

## Valores Perdidos

```{r valoresPerdidos}

# Miramos que variables tienen valores perdidos
sort(colSums(is.na(fifa)), decreasing = TRUE)
sort(colSums(fifa==""), decreasing = TRUE)
sort(colSums(fifa==0), decreasing = TRUE)

# Nos guardamos los índices de los valores perdidos
#ValPer.ind <- which(fifa$value_eur==0)

# Mostramos los registros con valores perdidos
#my.kable(fifa[ValPer.ind,])

# Rellenamos los NULLs con el método knn (vecino)
#df=as.data.frame(knnImputation(df,k = 5, scale = T))

# Mostramos los registros con NA
#my.kable(df[df_n_hos_beds_NA_Idx,])

```



**comentario:**
No tenemos valores NA.  
Blancos solo hay en la variable de *'nation_position'* que quiere decir que no han jugado con la selección.
Registros con valor 0 solo hay en el valor del jugador (*'value_eur'*)

TODO: Mirar que hacemos con estos valores.

## Valores Extremos

```{r boxplot}

gp1 <- ggplot(fifa, aes(x=team_position.Class, y=age, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp2 <- ggplot(fifa, aes(x=team_position.Class, y=overall, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp3 <- ggplot(fifa, aes(x=team_position.Class, y=potential, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp4 <- ggplot(fifa, aes(x=team_position.Class, y=height_cm, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp5 <- ggplot(fifa, aes(x=team_position.Class, y=weight_kg, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp6 <- ggplot(fifa, aes(x=team_position.Class, y=value_eur, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 
gp7 <- ggplot(fifa, aes(x=team_position.Class, y=wage_eur, fill=team_position.Class)) + geom_boxplot() + theme(legend.position="none") + xlab("") 

grid.arrange(gp1, gp2, gp3, gp4, ncol = 2)
grid.arrange(gp5, gp6, gp7, ncol = 2)

# Limpiamos memoria
rm(gp1, gp2, gp3, gp4, gp5, gp6, gp7)

#table(boxplot.stats(fifa$value_eur)$out)

```


## Correlacion

```{r corr}

fifa.var_cuanti <- unlist(lapply(fifa, is.numeric)) 
ggcorr(fifa[fifa.var_cuanti], label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)


```


